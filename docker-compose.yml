version: "3.8"

services:
    mongodb:
        image: mongo:7.0
        container_name: mongodb
        restart: unless-stopped
        ports:
            - "27017:27017"
        environment:
            MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER:-admin}
            MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-changeme123}
            MONGO_INITDB_DATABASE: ${MONGO_DATABASE:-admin}
        volumes:
            - mongodb_data:/data/db
            - mongodb_config:/data/configdb
            - ./init-mongo.js:/docker-entrypoint-initdb.d/init-mongo.js:ro
        networks:
            - mongo-network
        command: --auth
        healthcheck:
            test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test -u $${MONGO_INITDB_ROOT_USERNAME} -p $${MONGO_INITDB_ROOT_PASSWORD} --authenticationDatabase admin
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 40s
        deploy:
            resources:
                limits:
                    cpus: "2"
                    memory: 2G
                reservations:
                    cpus: "0.5"
                    memory: 512M

    mongo-express:
        image: mongo-express:1.0.0
        container_name: mongo-express
        restart: unless-stopped
        ports:
            - "8081:8081"
        environment:
            ME_CONFIG_MONGODB_ADMINUSERNAME: ${MONGO_ROOT_USER:-admin}
            ME_CONFIG_MONGODB_ADMINPASSWORD: ${MONGO_ROOT_PASSWORD:-changeme123}
            ME_CONFIG_MONGODB_URL: mongodb://${MONGO_ROOT_USER:-admin}:${MONGO_ROOT_PASSWORD:-changeme123}@mongodb:27017/
            ME_CONFIG_MONGODB_ENABLE_ADMIN: "true"
            ME_CONFIG_BASICAUTH: "true"
            ME_CONFIG_BASICAUTH_USERNAME: ${EXPRESS_USER:-admin}
            ME_CONFIG_BASICAUTH_PASSWORD: ${EXPRESS_PASSWORD:-changeme123}
            ME_CONFIG_OPTIONS_EDITORTHEME: monokai
        depends_on:
            mongodb:
                condition: service_healthy
        networks:
            - mongo-network

volumes:
    mongodb_data:
        driver: local
    mongodb_config:
        driver: local

networks:
    mongo-network:
        driver: bridge
